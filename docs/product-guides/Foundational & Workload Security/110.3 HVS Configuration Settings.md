# Verification Service
--------------------

## Installation Answer File Options

```yaml
# Default values for hvs

nameOverride: "" # The name for HVS chart<br> (Default: `.Chart.Name`)
controlPlaneHostname: <user input> # K8s control plane IP/Hostname<br> (**REQUIRED**)

# Warning: Ensure that the naming is applied consistently for all dependent services when modifying nameOverride
# TODO: Services should be be able to be deployed in different namespaces
dependentServices: # The dependent Service Name for deploying  HVS chart, default is the chart name and override is from nameOverride value.
  cms: cms
  aas: aas

config:
  envVarPrefix: HVS
  dbPort: 5432 # PostgreSQL DB port
  dbSSL: on # PostgreSQL DB SSL<br> (Allowed Values: `on`/`off`)
  dbSSLCert: /etc/postgresql/secrets/server.crt # PostgreSQL DB SSL Cert
  dbSSLKey: /etc/postgresql/secrets/server.key  # PostgreSQL DB SSL Key
  dbSSLCiphers: ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256 # PostgreSQL DB SSL Ciphers
  dbListenAddresses: "*" # PostgreSQL DB Listen Address
  dbName: hvsdb # HVS DB Name
  dbSSLMode: verify-full # PostgreSQL DB SSL Mode
  dbhostSSLPodRange: 10.1.0.0/8 # PostgreSQL DB Host Address(IP address/subnet-mask). IP range varies for different k8s network plugins(Ex: Flannel - 10.1.0.0/8 (default), Calico - 192.168.0.0/16).
  requireEKCertForHostProvision: <user input> # If set to true, worker node EK certificate should be registered in HVS DB, for AIK provisioning step of TA. (Allowed values: `true`\`false`)
  verifyQuoteForHostRegistration: <user input> # If set to true, when the worker node is being registered to HVS, quote verification will be done. Default value is false. (Allowed values: `true`\`false`)
  nats:
    enabled: false # Enable/Disable NATS mode<br> (Allowed values: `true`\`false`)
    servers: ""  # NATS Server IP/Hostname  
    serviceMode: "" # The model for TA<br> (Allowed values: `outbound`)
    
secret:
  dbUsername: hvsdbuser # DB Username for HVS DB
  dbPassword: hvsdbpassword # DB Password for HVS DB
  serviceUsername: hvsAdminUser # Admin Username for HVS
  servicePassword: hvsAdminPass # Admin Password for HVS

image:
  db:
    registry: dockerhub.io # The image registry where PostgreSQL image is pulled from
    name: postgres:11.7 # The image name of PostgreSQL
    pullPolicy: Always # The pull policy for pulling from container registry for PostgreSQL image
  svc:
    name: <user input> # The image name with which HVS image is pushed to registry<br> (**REQUIRED**)
    pullPolicy: Always # The pull policy for pulling from container registry for HVS<br> (Allowed values: `Always`/`IfNotPresent`)
    imagePullSecret:  # The image pull secret for authenticating with image registry, can be left empty if image registry does not require authentication

storage:
  nfs:
    server: <user input> # The NFS Server IP/Hostname<br> (**REQUIRED**)
    reclaimPolicy: Retain # The reclaim policy for NFS<br> (Allowed values: `Retain`/)
    accessModes: ReadWriteMany # The access modes for NFS<br> (Allowed values: `ReadWriteMany`)
    path: /mnt/nfs_share # The path for storing persistent data on NFS
    dbSize: 5Gi # The DB size for storing DB data for HVS in NFS path
    configSize: 10Mi # The configuration size for storing config for HVS in NFS path
    logsSize: 1Gi # The logs size for storing logs for HVS in NFS path
    baseSize: 6.1Gi # The base volume size (configSize + logSize + dbSize)

securityContext:
  hvsdbInit: # The fsGroup id for init containers for HVS DB
    fsGroup: 2000
  hvsdb: # The security content for HVS DB Service Pod
    runAsUser: 1001
    runAsGroup: 1001
  hvsInit: # The fsGroup id for init containers for HVS
    fsGroup: 1001
  hvs: # The security content for HVS Pod
    runAsUser: 1001
    runAsGroup: 1001
    capabilities:
      drop:
        - all
    allowPrivilegeEscalation: false

service:
  directoryName: hvs
  cms:
    containerPort: 8445 # The containerPort on which CMS can listen
  aas: 
    containerPort: 8444 # The containerPort on which AAS can listen
    port: 30444 # The externally exposed NodePort on which AAS can listen to external traffic
  hvsdb:
    containerPort: 5432 # The containerPort on which HVS DB can listen 
  hvs:
    containerPort: 8443 # The containerPort on which HVS can listen 
    port: 30443 # The externally exposed NodePort on which HVS can listen to external traffic
  ingress:
    enable: false # Accept true or false to notify ingress rules are enable or disabled
```


## Available Setup Tasks

```
        all                             Runs all setup tasks
        database                        Setup hvs database
        create-default-flavorgroup      Create default flavor groups in database
        create-default-flavor-template  Create default flavor templates in database
        create-dek                      Create data encryption key for HVS
        download-ca-cert                Download CMS root CA certificate
        download-cert-tls               Download CA certificate from CMS for tls
        download-cert-saml              Download CA certificate from CMS for saml
        download-cert-flavor-signing    Download CA certificate from CMS for flavor signing
        create-endorsement-ca           Generate self-signed endorsement certificate
        create-privacy-ca               Generate self-signed privacy certificate
        create-tag-ca                   Generate self-signed tag certificate
        update-service-config           Sets or Updates the Service configuration
```
## Environment Variables for Setup Tasks

Below are the environment varables that can be used to configure the setup tasks: 

### Database

```
    DB_SSL_CERT                 Database SSL certificate, or use HVS_DB_SSLCERT alternatively
    DB_SSL_CERT_SOURCE          Database SSL certificate to be copied from, or use HVS_DB_SSLCERTSRC alternatively
    DB_CONN_RETRY_TIME          Database connection retry time
    DB_HOST                     Database host name, or use HVS_DB_HOSTNAME alternatively
    DB_PORT                     Database port, or use HVS_DB_PORT alternatively
    DB_USERNAME                 Database username, or use HVS_DB_USERNAME alternatively
    DB_SSL_MODE                 Database SSL mode, or use HVS_DB_SSL_MODE alternatively
    DB_VENDOR                   Vendor of database, or use HVS_DB_VENDOR alternatively
    DB_NAME                     Database name, or use HVS_DB_NAME alternatively
    DB_PASSWORD                 Database password, or use HVS_DB_PASSWORD alternatively
    DB_CONN_RETRY_ATTEMPTS      Database connection retry attempts
```

### Update-service-config

```
    HRRS_REFRESH_PERIOD                         Host report refresh service period
    HOST_TRUST_CACHE_THRESHOLD                  Maximum number of entries to be cached in the Trust/Flavor caches
    NAT_SERVERS                                 List of NATs servers to establish connection with outbound TAs
    SERVICE_PASSWORD                            The service password as configured in AAS
    AAS_BASE_URL                                AAS Base URL
    FVS_NUMBER_OF_DATA_FETCHERS                 Number of Flavor verification data fetcher threads
    FVS_SKIP_FLAVOR_SIGNATURE_VERIFICATION      Skips flavor signature verification when set to true
    SERVER_PORT                                 The Port on which Server listens to
    SERVER_READ_HEADER_TIMEOUT                  Request Read Header Timeout Duration in Seconds
    SERVER_WRITE_TIMEOUT                        Request Write Timeout Duration in Seconds
    LOG_ENABLE_STDOUT                           Enable console log
    FVS_NUMBER_OF_VERIFIERS                     Number of Flavor verification verifier threads
    SERVER_READ_TIMEOUT                         Request Read Timeout Duration in Seconds
    SERVER_IDLE_TIMEOUT                         Request Idle Timeout in Seconds
    SERVICE_USERNAME                            The service username as configured in AAS
    LOG_MAX_LENGTH                              Max length of log statement
    SERVER_MAX_HEADER_BYTES                     Max Length of Request Header in Bytes
    ENABLE_EKCERT_REVOKE_CHECK                  If enabled, revocation checks will be performed for EK certs at the time of AIK provisioning
    LOG_LEVEL                                   Log level
    VCSS_REFRESH_PERIOD                         VCenter refresh service period
```

### Download-cert-flavor-signing

Mandatory:

```
    CMS_BASE_URL        CMS base URL in the format https://{{cms}}:{{cms_port}}/cms/v1/
    BEARER_TOKEN        Bearer token for accessing CMS api
```
Optional:

```
    FLAVOR_SIGNING_CERT_FILE    The file to which certificate is saved
    FLAVOR_SIGNING_KEY_FILE     The file to which private key is saved
    FLAVOR_SIGNING_COMMON_NAME  The common name of signed certificate
```

### Create-privacy-ca

```
    PRIVACY_CA_KEY_FILE         The file to which private key is saved
    PRIVACY_CA_COMMON_NAME      The common name of signed certificate
    PRIVACY_CA_ISSUER           The issuer of signed certificate
    PRIVACY_CA_VALIDITY_YEARS   The validity time in years of signed certificate
    PRIVACY_CA_CERT_FILE        The file to which certificate is saved
```

### Create-endorsement-ca

```
    ENDORSEMENT_CA_KEY_FILE             The file to which private key is saved
    ENDORSEMENT_CA_COMMON_NAME          The common name of signed certificate
    ENDORSEMENT_CA_ISSUER               The issuer of signed certificate
    ENDORSEMENT_CA_VALIDITY_YEARS       The validity time in years of signed certificate
    ENDORSEMENT_CA_CERT_FILE            The file to which certificate is saved
```

### Create-tag-ca

```
    TAG_CA_CERT_FILE            The file to which certificate is saved
    TAG_CA_KEY_FILE             The file to which private key is saved
    TAG_CA_COMMON_NAME          The common name of signed certificate
    TAG_CA_ISSUER               The issuer of signed certificate
    TAG_CA_VALIDITY_YEARS       The validity time in years of signed certificate
```

### Database

```
    DB_VENDOR                   Vendor of database, or use HVS_DB_VENDOR alternatively
    DB_NAME                     Database name, or use HVS_DB_NAME alternatively
    DB_PASSWORD                 Database password, or use HVS_DB_PASSWORD alternatively
    DB_CONN_RETRY_ATTEMPTS      Database connection retry attempts
    DB_CONN_RETRY_TIME          Database connection retry time
    DB_HOST                     Database host name, or use HVS_DB_HOSTNAME alternatively
    DB_PORT                     Database port, or use HVS_DB_PORT alternatively
    DB_USERNAME                 Database username, or use HVS_DB_USERNAME alternatively
    DB_SSL_MODE                 Database SSL mode, or use HVS_DB_SSL_MODE alternatively
    DB_SSL_CERT                 Database SSL certificate, or use HVS_DB_SSLCERT alternatively
    DB_SSL_CERT_SOURCE          Database SSL certificate to be copied from, or use HVS_DB_SSLCERTSRC alternatively
```

### Download-ca-cert

```
    CMS_BASE_URL                CMS base URL in the format https://{{cms}}:{{cms_port}}/cms/v1/
    CMS_TLS_CERT_SHA384         SHA384 hash value of CMS TLS certificate
```

### Download-cert-tls

Mandatory:
```
    CMS_BASE_URL        CMS base URL in the format https://{{cms}}:{{cms_port}}/cms/v1/
    BEARER_TOKEN        Bearer token for accessing CMS api
```

Optional:

```
    TLS_CERT_FILE       The file to which certificate is saved
    TLS_KEY_FILE        The file to which private key is saved
    TLS_COMMON_NAME     The common name of signed certificate
    TLS_SAN_LIST        Comma separated list of hostnames to add to Certificate, including IP addresses and DNS names
```

### Download-cert-saml

Mandatory:

```
    CMS_BASE_URL        CMS base URL in the format https://{{cms}}:{{cms_port}}/cms/v1/
    BEARER_TOKEN        Bearer token for accessing CMS api
```

Optional:

```
    SAML_CERT_FILE      The file to which certificate is saved
    SAML_KEY_FILE       The file to which private key is saved
    SAML_COMMON_NAME    The common name of signed certificate

    SAML_ISSUER                 The issuer of signed certificate
    SAML_VALIDITY_SECONDS       The validity time in seconds of signed certificate
```

### Hvs-credentials

```
HVS_ADMIN_USERNAME   
HVS_ADMIN_PASSWORD 
```

### Hvsdb-credentials

```
HVS_DB_USERNAME   
HVS_DB_PASSWORD 
```


## Configuration Options in `config.yml`

The below settings can be directly edited in the `config.yml` file in the persistent config volume.

```yaml
tls:
  cert-file: /etc/hvs/tls-cert.pem
  key-file: /etc/hvs/tls.key
  common-name: HVS TLS Certificate
  san-list: 127.0.0.1,localhost
saml:
  common:
    cert-file: /etc/hvs/certs/trustedca/saml-cert.pem
    key-file: /etc/hvs/trusted-keys/saml.key
    common-name: HVS SAML Certificate
  issuer: AttestationService
  validity-days: 1
flavor-signing:
  cert-file: /etc/hvs/certs/trustedca/flavor-signing.pem
  key-file: /etc/hvs/trusted-keys/flavor-signing.key
  common-name: HVS Flavor Signing Certificate
privacy-ca:
  cert-file: /etc/hvs/certs/trustedca/privacy-ca/privacy-ca-cert.pem
  key-file: /etc/hvs/trusted-keys/privacy-ca.key
  common-name: HVS Privacy Certificate
  issuer: intel-secl
  validity-years: 5
endorsement-ca:
  cert-file: /etc/hvs/certs/endorsement/EndorsementCA.pem
  key-file: /etc/hvs/trusted-keys/endorsement-ca.key
  common-name: HVS Endorsement Certificate
  issuer: intel-secl
  validity-years: 5
tag-ca:
  cert-file: /etc/hvs/certs/trustedca/tag-ca-cert.pem
  key-file: /etc/hvs/trusted-keys/tag-ca.key
  common-name: HVS Tag Certificate
  issuer: intel-secl
  validity-years: 5
aik-certificate-validity-years: 5
server:
  port: 8898
  read-timeout: 30s
  read-header-timeout: 10s
  write-timeout: 30s
  idle-timeout: 10s
  max-header-bytes: 1048576
log:
  max-length: 30000
  enable-stdout: true
  level: TRACE
db:
  vendor: postgres
  host: localhost
  port: "5432"
  name: hvs_db
  username: root
  password: password
  ssl-mode: allow
  ssl-cert: /etc/hvs/hvsdbsslcert.pem
  conn-retry-attempts: 5
  conn-retry-time: 1
hrrs:
  refresh-period: 2m0s
  refresh-look-ahead: 5m0s
fvs:
  number-of-verifiers: 20
  number-of-data-fetchers: 20
  skip-flavor-signature-verification: true
```
