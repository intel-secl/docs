# Authentication and Authorization Service

## Installation Answer File Options

```yaml

# Default values for aas.

nameOverride: "" # The name for AAS chart<br> (Default: `.Chart.Name`)
controlPlaneHostname: <user input> # K8s control plane IP/Hostname<br> (**REQUIRED**)

# Warning: Ensure that the naming is applied consistently for all dependent services when modifying nameOverride
# TODO: Services should be be able to be deployed in different namespaces
dependentServices: # The dependent Service Name for deploying  Authentication and Authorization Service chart, default is the chart name and override is from nameOverride value.
  cms: cms

config:
  envVarPrefix: AAS
  dbPort: 5432 # PostgreSQL DB port
  dbSSL: on # PostgreSQL DB SSL<br> (Allowed: `on`/`off`)
  #TODO: to remove the below values if hardcoding the path
  dbSSLCert: /etc/postgresql/secrets/server.crt # PostgreSQL DB SSL Cert
  dbSSLKey: /etc/postgresql/secrets/server.key # PostgreSQL DB SSL Key
  dbSSLCiphers: ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256 # PostgreSQL DB SSL Ciphers
  dbListenAddresses: "*" # PostgreSQL DB Listen Address
  dbName: aasdb # AAS DB Name
  dbSSLMode: verify-full # PostgreSQL DB SSL Mode
  dbhostSSLPodRange: 10.1.0.0/8 # PostgreSQL DB Host Address(IP address/subnet-mask). IP range varies for different k8s network plugins(Ex: Flannel - 10.1.0.0/8 (default), Calico - 192.168.0.0/16).
  createCredentials: true # Trigger to run create-credentials setup task when set to True. Default is False

secret:
  dbUsername: aasdbuser # DB Username for AAS DB
  dbPassword: aasdbpassword # DB Password for AAS DB
  adminUsername: aasAdminUser # Admin Username for AAS
  adminPassword: aasAdminPass # Admin Password for AAS
    
image:
  db:
    registry: dockerhub.io # The image registry where PostgreSQL image is pulled from
    name: postgres:11.7 # The image name of PostgreSQL
    pullPolicy: Always # The pull policy for pulling from container registry for PostgreSQL image<br> (Allowed values: `Always`/`IfNotPresent`)
  svc:
    name: <user input> # The image name with which AAS image is pushed to registry
    pullPolicy: Always # The pull policy for pulling from container registry for AAS<br> (Allowed values: `Always`/`IfNotPresent`)
    imagePullSecret:  # The image pull secret for authenticating with image registry, can be left empty if image registry does not require authentication
    initName: <user input> # The image name of init container

storage:
  nfs:
    server: <user input> # The NFS Server IP/Hostname
    reclaimPolicy: Retain # The reclaim policy for NFS<br> (Allowed values: `Retain`/)
    accessModes: ReadWriteMany # The access modes for NFS<br> (Allowed values: `ReadWriteMany`)
    path: /mnt/nfs_share # The path for storing persistent data on NFS
    dbSize: 1Gi # The DB size for storing DB data for AAS in NFS path
    configSize: 10Mi # The configuration size for storing config for AAS in NFS path
    logsSize: 1Gi # The logs size for storing logs for AAS in NFS path
    baseSize: 2.1Gi # The base volume size (configSize + logSize + dbSize)

securityContext:
  aasdbInit: # The fsGroup id for init containers for AAS DB
    fsGroup: 1001
  aasdb: # The security content for AAS DB Service Pod
    runAsUser: 1001
    runAsGroup: 1001
  aasInit: # The fsGroup id for init containers for AAS
    fsGroup: 1001
  aas: # The security content for AAS Pod
    runAsUser: 1001
    runAsGroup: 1001
    capabilities:
      drop:
        - all
    allowPrivilegeEscalation: false

service: 
  directoryName: authservice
  cms:
    containerPort: 8445 # The containerPort on which CMS can listen
    port: 30445 # The externally exposed NodePort on which CMS can listen to external traffic
  aasdb:
    containerPort: 5432 # The containerPort on which AAS DB can listen 
  aas:
    containerPort: 8444 # The containerPort on which AAS can listen
    port: 30444 # The externally exposed NodePort on which AAS can listen to external traffic
  ingress:
    enable: false # Accept true or false to notify ingress rules are enable or disabled

```



## Available Setup Tasks

```
    all                      Runs all setup tasks
    download-ca-cert         Download CMS root CA certificate
    download-cert-tls        Download CA certificate from CMS for tls
    database                 Setup authservice database
    admin                    Add authservice admin username and password to database and assign respective
                             roles to the user
    jwt                      Create jwt signing key and jwt certificate signed by CMS
    create-credentials       Generates credentials to support third party authentication and authorization
    update-service-config    Sets or Updates the Service configuration
```
## Environment Variables for Setup Tasks

Below are the environment varables that can be used to configure the setup tasks:

### Download-ca-cert

```
    CMS_BASE_URL                CMS base URL in the format https://{{cms}}:{{cms_port}}/cms/v1/
    CMS_TLS_CERT_SHA384         SHA384 hash value of CMS TLS certificate
```

### Download-cert-tls

```
    CMS_BASE_URL        CMS base URL in the format https://{{cms}}:{{cms_port}}/cms/v1/
    BEARER_TOKEN        Bearer token for accessing CMS api
```

### Download-cert-tls

```
    TLS_CERT_FILE       The file to which certificate is saved
    TLS_KEY_FILE        The file to which private key is saved
    TLS_COMMON_NAME     The common name of signed certificate
    TLS_SAN_LIST        Comma separated list of hostnames to add to Certificate, including IP addresses and DNS names
```

### Database

```
    DB_VENDOR                   Vendor of database, or use AAS_DB_VENDOR alternatively
    DB_PORT                     Database port, or use AAS_DB_PORT alternatively
    DB_NAME                     Database name, or use AAS_DB_NAME alternatively
    AAS_DB_PASSWORD             Database password, or use DB_PASSWORD alternatively
    DB_SSL_MODE                 Database SSL mode, or use AAS_DB_SSL_MODE alternatively
    DB_SSL_CERT_SOURCE          Database SSL certificate to be copied from, or use AAS_DB_SSLCERTSRC alternatively
    DB_CONN_RETRY_TIME          Database connection retry time
    DB_HOST                     Database host name, or use AAS_DB_HOSTNAME alternatively
    AAS_DB_USERNAME             Database username, or use DB_USERNAME alternatively
    DB_SSL_CERT                 Database SSL certificate, or use AAS_DB_SSLCERT alternatively
    DB_CONN_RETRY_ATTEMPTS      Database connection retry attempts
```

### Admin

```
    AAS_ADMIN_USERNAME  Authentication and Authorization Service Admin Username 
    AAS_ADMIN_PASSWORD  Authentication and Authorization Service Admin Password
```

### Jwt

Mandatory:

```
    CMS_BASE_URL        CMS base URL in the format https://{{cms}}:{{cms_port}}/cms/v1/
    BEARER_TOKEN        Bearer token for accessing CMS api
```
Optional:

```
    KEY_FILE            The file to which private key is saved
    COMMON_NAME         The common name of signed certificate
    CERT_FILE           The file to which certificate is saved
```

### Create-credentials setup:

```
    CREATE_CREDENTIALS                  Trigger to run create-credentials setup task when set to True. Default is False
    NATS_OPERATOR_NAME                  Set the NATS operator name, default is "ISecL-operator"
    NATS_OPERATOR_CREDENTIAL_VALIDITY   Set the NATS operator credential validity in terms of duration (ex: "300ms","-1.5h" or "2h45m"), default is 5 years
    NATS_ACCOUNT_NAME                   Set the NATS account name, default is "ISecL-account"
    NATS_ACCOUNT_CREDENTIAL_VALIDITY    Set the NATS account credential validity in terms of duration (ex: "300ms","-1.5h" or "2h45m"), default is 5 years
    NATS_USER_CREDENTIAL_VALIDITY       Set the NATS user credential validity in terms of duration (ex: "300ms","-1.5h" or "2h45m"), default is 1 year
```

### Update-service-config setup:

```
    NATS_USER_CREDENTIAL_VALIDITY               Set the NATS user credential validity, default is 1 year
    JWT_INCLUDE_KID                             Includes JWT Key Id for token validation
    JWT_TOKEN_DURATION_MINS                     Validity of token duration
    AUTH_DEFENDER_MAX_ATTEMPTS                  Auth defender maximum attempts
    SERVER_READ_TIMEOUT                         Request Read Timeout Duration in Seconds
    SERVER_WRITE_TIMEOUT                        Request Write Timeout Duration in Seconds
    NATS_OPERATOR_NAME                          Set the NATS operator name, default is "ISecL-operator"
    LOG_MAX_LENGTH                              Max length of log statement
    AUTH_DEFENDER_LOCKOUT_DURATION_MINS         Auth defender lockout duration in minutes
    NATS_ACCOUNT_CREDENTIAL_VALIDITY            Set the NATS account credential validity, default is 5 years
    LOG_LEVEL                                   Log level
    SERVER_PORT                                 The Port on which Server Listens to
    SERVER_READ_HEADER_TIMEOUT                  Request Read Header Timeout Duration in Seconds
    NATS_ACCOUNT_NAME                           Set the NATS account name, default is "ISecL-account"
    LOG_ENABLE_STDOUT                           Enable console log
    JWT_CERT_COMMON_NAME                        Common Name for JWT Certificate
    AUTH_DEFENDER_INTERVAL_MINS                 Auth defender interval in minutes
    SERVER_IDLE_TIMEOUT                         Request Idle Timeout in Seconds
    SERVER_MAX_HEADER_BYTES                     Max Length Of Request Header in Bytes
    NATS_OPERATOR_CREDENTIAL_VALIDITY           Set the NATS operator credential validity, default is 5 years
```

### Aas-credentials secrets:

```
AAS_ADMIN_USERNAME   
AAS_ADMIN_PASSWORD 
```

### Aasdb-credentials

```
AAS_DB_USERNAME   
AAS_DB_PASSWORD 
```

## Configuration Options in `config.yml`

The below settings can be directly edited in the `config.yml` file in the persistent config volume.

```yaml
cms-base-url: https://cms-svc.isecl.svc.cluster.local:8445/cms/v1
cms-tls-cert-sha384: ...
aas:
  service-username: <username>
  service-password: <password>
db:
  vendor: postgres
  host: aasdb-svc.isecl.svc.cluster.local
  port: 5432
  name: aasdb
  username: <username>
  password: <password>
  ssl-mode: verify-full
  ssl-cert: /etc/postgresql/server.crt
  conn-retry-attempts: 4
  conn-retry-time: 1
log:
  max-length: 1500
  enable-stdout: true
  level: info
auth-defender:
  max-attempts: 5
  interval-mins: 5
  lockout-duration-mins: 15
jwt:
  include-kid: true
  token-duration-mins: 120
  cert-common-name: AAS JWT Signing Certificate
tls:
  cert-file: /etc/authservice/tls-cert.pem
  key-file: /etc/authservice/tls.key
  common-name: AAS TLS Certificate
  san-list: aas-svc.isecl.svc.cluster.local,...
server:
  port: 8444
  read-timeout: 30s
  read-header-timeout: 10s
  write-timeout: 10s
  idle-timeout: 10s
  max-header-bytes: 1048576
nats:
  operator:
    name: ISecL-operator
    credential-validity: 43800h0m0s
  account:
    name: ISecL-account
    credential-validity: 43800h0m0s
  user-credential-validity: 8760h0m0s

```